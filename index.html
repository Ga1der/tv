<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
              content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>Document</title>
        <link rel="manifest" href="/tv/manifest.json">
    	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <style>
            #divan_tv {
                color: darkgreen;
                width: 100%;
                font-family: monospace;
                white-space: pre-wrap;
            }

            .channels {
                --column-count: 3;
                max-width: 100%;
            }

            label {
                display: block;
                text-align: center;
                min-width: 120px;
            }

            input.channel:checked ~ img {
                box-shadow: 1px 1px 5px 5px darkgreen;
                /*border: double darkgreen 5px;*/
            }

            img.channel {
                box-sizing: border-box;
                background: lightgray;
                border-radius: 5px;
                max-height: 60px;
                margin: 5px 0;
            }
        </style>
        <script defer>
    		class Divan {
    			constructor () 
    			{
                    this.client_key = '8a66efabeee725d313673361fa3728c21430809f'; // magic!
    				
                    this.user_email = new Date().getTime() + '@mail.com';
                    this.user_password = 11111111;
                    this.user_code = '010ysxi155';
                    this.user_favorite_channels = {};

                    this.response_authorization;
                    this.response_channels;
                    this.response_registration;
                    this.response_login;
    			}

				apiAuth () 
				{
	                $.ajax({
	                    async: false,
	                    method: 'get',
	                    url: 'https://api.divan.tv/v1/authorization',
	                    headers: {
	                        //'Origin': 'https://galder.io.ua'
	                    },
	                    data: {
	                        client_key: this.client_key,
	                        device_type: 1,
	                    },
	                    success: (data, textStatus, jqXHR) => {
							this.response_authorization = data.data;
		                    console.info(this.response_authorization);
	                    }
	                });

	                return this; 
				}

				apiChannels () 
				{
	                $.ajax({
	                    async: false,
	                    method: 'get',
	                    url: 'https://api.divan.tv/v1/channels/browse',
	                    data: {
	                        authorization_key: this.response_authorization.authorization_key,
	                        limit: 999,
	                    },
	                    success: (data, textStatus, jqXHR) => {
		                    this.response_channels = data.data.data;
		                    console.info(this.response_channels);
	                    }
	                });

	                return this; 
				}

                getFavoriteChannels () 
                {
                    let favorite = window.localStorage.getItem('user_favorite_channels');
                    if (!favorite) return [
                        2, 14, 8, 67, 18, 19, 135, 29, 148, 152, 342, 1051, 
                        704, 1167, 1224, 1174, 116, 306, 258, 34, 10, 1378
                    ];
                    favorite = JSON.parse(favorite);
                    favorite = Object.keys(favorite);
                    favorite = favorite.map((id, name) => 1 * id);
                    console.log(favorite);

                    return favorite;
                }

                favoriteChannelAdd (channel_id) 
                {
                    const channel = this.response_channels.find(element => element.id == channel_id);
                    this.user_favorite_channels[channel_id] = channel.title.RU;
                    window.localStorage.setItem('user_favorite_channels', JSON.stringify(this.user_favorite_channels));
                }

                favoriteChannelRemove (channel_id) 
                {
                    delete this.user_favorite_channels[channel_id];
                    window.localStorage.setItem('user_favorite_channels', JSON.stringify(this.user_favorite_channels));
                }

				apiRegister () 
				{
                    $.ajax({
                        async: false,
                        method: 'post',
                        url: 'https://api.divan.tv/v1/accounts/registration/',
                        data: {
                            authorization_key: this.response_authorization.authorization_key,
                            email: this.user_email,
                            password: this.user_password,
                            lang_code: 'RU',
                        },
                        success: (data, textStatus, jqXHR) => {
                            this.response_registration = data.data.data;
                            console.info(this.response_registration);
                        }
                    });
				}

				apiLogin () 
				{
                    $.ajax({
                        async: false,
                        method: 'post',
                        url: 'https://api.divan.tv/v1/accounts/login/',
                        data: {
                            authorization_key: this.response_authorization.authorization_key,
                            login: this.user_email,
                            password: this.user_password,
                        },
                        success: (data, textStatus, jqXHR) => {
                            this.response_login = data.data.data;
                            console.info(this.response_login);
                        }
                    });
				}

				apiPromoCode () 
				{
                    $.ajax({
                        async: true,
                        method: 'post',
                        url: 'https://api.divan.tv/v1/promomarkers/activate/',
                        data: {
                            authorization_key: this.response_authorization.authorization_key,
                            code: this.user_code,
                        },
                        success: (data, textStatus, jqXHR) => {
                            console.info(data.data);
                        }
                    });
				}

                apiFavoriteChannelAdd (channel_id) 
                {
                    $.ajax({
                        async: true,
                        method: 'post',
                        url: 'https://api.divan.tv/v1/channels_favorites/add/',
                        data: {
                            authorization_key: this.response_authorization.authorization_key,
                            channel_id: channel_id,
                        },
                        success: (data, textStatus, jqXHR) => {
                            console.info(data.data.data);
                            this.favoriteChannelAdd(channel_id);
                        }
                    });
                }

                apiFavoriteChannelDelete (channel_id) 
                {
                    $.ajax({
                        async: true,
                        method: 'post',
                        url: 'https://api.divan.tv/v1/channels_favorites/remove/',
                        data: {
                            authorization_key: this.response_authorization.authorization_key,
                            channel_id: channel_id,
                        },
                        success: (data, textStatus, jqXHR) => {
                            console.info(data.data.data);
                            this.favoriteChannelRemove(channel_id);
                        }
                    });
                }
    		}
        </script>
        <script defer>
            class DivanUI 
            {
                constructor (divan) 
                {
                    this.divan = divan;
                }

                drawChannels () 
                {
                    const response_channels = this.divan.response_channels; 
                    for (let i in response_channels) {
                        (function () {
                            let channel       = response_channels[i],
                                input         = $(`<input type="checkbox" class="channel" value="${channel.id}" hidden/>`),
                                image         = $(`<img src="${channel.image.sm}" class="channel"/>`),
                                label         = $(`<label title="${channel.id}   \t:\t ${channel.title.RU}" style="cursor: pointer;"/>`),
                                channels      = $('.channels');
                            label.addClass('col');
                            label.append(input);
                            label.append(image);
                            channels.append(label);
                        }());
                    }

                    $('#get_code').prop('disabled', false);
                }

                enableFavoriteChannals () 
                {
                    const favorite = this.divan.getFavoriteChannels();
                    $('.channels input.channel').map(function () {
                        const channel_id = 1 * this.value;
                        // const is_favorite = (-1 < favorite.indexOf(channel_id));
                        const is_favorite = favorite.includes(channel_id);
                        this.parentElement.style.order = (is_favorite ? 1 : 2);
                        this.checked = (is_favorite ? true : false);
                    });
                }

                onGetCode () 
                {
                    const divan = this.divan;
                    $('#get_code').on('click', () =>  {
                        if (!divan.response_login) {
                            divan.apiRegister();
                            divan.apiLogin();
                            divan.apiPromoCode();
                        }

                        $('.channels input.channel').map((key, element) => {
                            element.checked
                                ? divan.apiFavoriteChannelAdd(element.value)
                                : divan.apiFavoriteChannelDelete(element.value);
                        });
                        
                        $('#divan_tv').text(JSON.stringify({
                            email: divan.response_registration.email,
                            login: divan.response_registration.id,
                            password: divan.user_password,
                            favorite: divan.user_favorite_channels,
                        }, null, "  "));
                    });
                }
            }
        </script>
        <script defer>
            $(function () {
                const divan = new Divan();
                divan.apiAuth();
                divan.apiChannels();

                const divanUI = new DivanUI(divan);
                divanUI.drawChannels();
                divanUI.enableFavoriteChannals();
                divanUI.onGetCode();
            });
        </script>
    </head>
    <body class="content">
        <div class="">
            <hr/>
            <div id="divan_tv"></div>
            <hr/>
            <button id="get_code" class="btn btn-success btn-xl btn-block" disabled>получить!</button>
            <hr/>
            <div class="channels row"></div>
            <hr/>
        </div>
    </body>
</html>
